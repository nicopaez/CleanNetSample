<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" DefaultTargets="Test">

  <ItemGroup>
    <Solution Include="CleanSample.sln">
      <Properties>Configuration=Debug;Platform=Any CPU</Properties>
    </Solution>
  </ItemGroup>

 <Target Name="RestorePackages" >
    <PropertyGroup>
      <NuGetExe>"C:\BuildTools\NuGet\nuget.exe"</NuGetExe>
    </PropertyGroup>
    <Exec Command="$(NuGetExe) restore -PackagesDirectory packages" />
  </Target>
  
<Target Name="Build" DependsOnTargets="RestorePackages">
  <MSBuild Projects="@(Solution)" Targets="ReBuild" />
</Target>

 <Target Name="RunMigrations" DependsOnTargets="Build">
  <MSBuild Projects="MyProject.Migrations\MigrationScript.xml"  />
 </Target>

 <Target Name="Test" DependsOnTargets="Build">
    <PropertyGroup>
      <NUnitExe>"C:\BuildTools\NUnit\nunit-console\nunit3-console.exe"</NUnitExe>
    </PropertyGroup>
    <CreateItem Include="**\bin\Debug\*Tests.dll">
      <Output TaskParameter="Include" ItemName="TestAssemblies" />
    </CreateItem>
    <Exec Command="$(NUnitExe) @(TestAssemblies,' ') --result:TestResult.xml;transform=C:\BuildTools\NUnit\nunit3-junit.xslt" />
  </Target>
  
   <PropertyGroup>
      <OpenCoverMSBuildTasksPath>C:\BuildTools\OpenCover\MSBuild</OpenCoverMSBuildTasksPath>
      <OpenCoverMSBuildTasksLib>$(OpenCoverMSBuildTasksPath)\OpenCover.MSBuild.dll</OpenCoverMSBuildTasksLib>
    </PropertyGroup>

   <UsingTask AssemblyFile="$(OpenCoverMSBuildTasksLib)" TaskName="OpenCover.MSBuild.OpenCover" />

  <Target Name="TestWithCoverage" DependsOnTargets="Build">
    <CreateItem Include="**\bin\Debug\*Tests.dll">
      <Output TaskParameter="Include" ItemName="TestAssemblies" />
    </CreateItem>
    <Exec Command="C:\BuildTools\OpenCover\OpenCoverConsole\OpenCover.Console.exe -register:user -showunvisited -returntargetcode -target:C:\BuildTools\NUnit\nunit-console\nunit3-console.exe -targetargs:&quot;@(TestAssemblies,' ') --result:TestResult.xml;transform=C:\BuildTools\NUnit\nunit3-junit.xslt&quot; -filter:&quot;+[Intelligize*]* -[*.Tests]*&quot; -excludebyattribute:System.ObsoleteAttribute -output:coverage-results.xml" />
    <Exec Command="C:\BuildTools\OpenCover\ReportGenerator\ReportGenerator.exe -reports:coverage-results.xml -targetDir:CodeCoverageHTML" />
    <Exec Command="c:\BuildTools\OpenCover\OpenCoverToCobertura\OpenCoverToCoberturaConverter.exe -input:coverage-results.xml -output:Cobertura.xml -sources:CodeCoverageHTML" />
  </Target>
   
</Project>